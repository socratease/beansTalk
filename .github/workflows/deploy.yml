name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: pages-main
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare static files
        run: |
          mkdir -p out
          mkdir -p out/script
          # Non-script version (default)
          cp index.html out/
          cp beanstalk-preview.jsx out/
          # Script version (at /script/)
          cp script/index.html out/script/
          cp beanstalk-preview-script.jsx out/

      - name: Add .nojekyll
        run: touch out/.nojekyll

      - name: Checkout gh-pages to preserve PR previews
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-current
        continue-on-error: true

      - name: Preserve only open PR preview directories
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -d "gh-pages-current/pr" ]; then
            mkdir -p out/pr
            # Get list of open PR numbers
            OPEN_PRS=$(gh pr list --state open --json number --jq '.[].number' 2>/dev/null || echo "")

            # Copy only directories for open PRs
            for pr_dir in gh-pages-current/pr/*/; do
              if [ -d "$pr_dir" ]; then
                pr_num=$(basename "$pr_dir")
                if echo "$OPEN_PRS" | grep -q "^${pr_num}$"; then
                  echo "Preserving preview for open PR #$pr_num"
                  cp -r "$pr_dir" "out/pr/$pr_num"
                else
                  echo "Cleaning up preview for closed PR #$pr_num"
                fi
              fi
            done

            # Remove pr directory if empty
            if [ -z "$(ls -A out/pr 2>/dev/null)" ]; then
              rm -rf out/pr
            fi
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          force_orphan: false
